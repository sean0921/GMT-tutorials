#!/bin/bash
# insert the following in output html files generated by sphinx, which are in _build/html/:
# 1. a justfont javascript after the </head> tag
# 2. a disqus javascript before the <div role="contentinfo"> tag
# 3. locale menu
# by Whyjay Zheng, first edition on 2016/1/12, last edited on 2017/10/22 (added google fonts for english)

html_files=$(ls docs/_build/html/*.html docs/_build/html/en/*.html)

google_fonts=$(cat SOURCE_DOCS/_static/google_fonts.txt)
jf_string=$(cat SOURCE_DOCS/_static/jf_code.txt)
disqus_string=$(cat SOURCE_DOCS/_static/disqus_code.txt)
localemenu=$(cat docs/_static/localemenu.txt)

# refer to the escape characters...
# http://unix.stackexchange.com/questions/32907/what-characters-do-i-need-to-escape-when-using-sed-in-a-sh-script
google_fonts=${google_fonts//\\/\\\\}     # changes all "\" to "\\"
google_fonts=${google_fonts//\[/\\\[}     # changes all "[" to "\["
google_fonts=${google_fonts//\]/\\\]}     # changes all "]" to "\]"
google_fonts=${google_fonts//\$/\\\$}     # changes all "$" to "\$"
google_fonts=${google_fonts//\./\\\.}     # changes all "." to "\."
google_fonts=${google_fonts//\*/\\\*}     # changes all "*" to "\*"
google_fonts=${google_fonts//\^/\\\^}     # changes all "^" to "\^"
google_fonts=${google_fonts//\//\\\/}     # changes all "/" to "\/"
google_fonts=${google_fonts//\"/\\\"}     # changes all '"' to '\"'

jf_string=${jf_string//\\/\\\\}     # changes all "\" to "\\"
jf_string=${jf_string//\[/\\\[}     # changes all "[" to "\["
jf_string=${jf_string//\]/\\\]}     # changes all "]" to "\]"
jf_string=${jf_string//\$/\\\$}     # changes all "$" to "\$"
jf_string=${jf_string//\./\\\.}     # changes all "." to "\."
jf_string=${jf_string//\*/\\\*}     # changes all "*" to "\*"
jf_string=${jf_string//\^/\\\^}     # changes all "^" to "\^"
jf_string=${jf_string//\//\\\/}     # changes all "/" to "\/"
jf_string=${jf_string//\"/\\\"}     # changes all '"' to '\"'

disqus_string=${disqus_string//\\/\\\\}     # changes all "\" to "\\"
disqus_string=${disqus_string//\[/\\\[}     # changes all "[" to "\["
disqus_string=${disqus_string//\]/\\\]}     # changes all "]" to "\]"
disqus_string=${disqus_string//\$/\\\$}     # changes all "$" to "\$"
disqus_string=${disqus_string//\./\\\.}     # changes all "." to "\."
disqus_string=${disqus_string//\*/\\\*}     # changes all "*" to "\*"
disqus_string=${disqus_string//\^/\\\^}     # changes all "^" to "\^"
disqus_string=${disqus_string//\//\\\/}     # changes all "/" to "\/"
disqus_string=${disqus_string//\"/\\\"}     # changes all '"' to '\"'

localemenu=${localemenu//\\/\\\\}     # changes all "\" to "\\"
localemenu=${localemenu//\[/\\\[}     # changes all "[" to "\["
localemenu=${localemenu//\]/\\\]}     # changes all "]" to "\]"
localemenu=${localemenu//\$/\\\$}     # changes all "$" to "\$"
localemenu=${localemenu//\./\\\.}     # changes all "." to "\."
localemenu=${localemenu//\*/\\\*}     # changes all "*" to "\*"
localemenu=${localemenu//\^/\\\^}     # changes all "^" to "\^"
localemenu=${localemenu//\//\\\/}     # changes all "/" to "\/"
localemenu=${localemenu//\"/\\\"}     # changes all '"' to '\"'

# start to insert

for html_f in $html_files
do
    # ==== Attaching google fonts code ====
    if grep -q 'googleapis' $html_f; then
        echo skip ${html_f##*/} - already attached the google fonts code
    else
        echo ----- Attaching google fonts code to ${html_f##*/} ...
        # insert a new line after theme.css line
        sed -i "/theme.css/a\ $google_fonts" $html_f
    fi
    # ==== Attaching jf code ====
    if grep -q 'jf.push' $html_f; then
        echo skip ${html_f##*/} - already attached the jf code
    else
        echo ----- Attaching jf code to ${html_f##*/} ...
        # insert a new line after </head> tag
        sed -i "/<\/head>/a\ $jf_string" $html_f
    fi
    # ==== Attaching disqus code ====
    if grep -q 'disqus_thread' $html_f; then
        echo skip ${html_f##*/} - already attached the disqus code
    else
        echo ----- Attaching disqus code to ${html_f##*/} ...
        dyn_id=${html_f##*/}
        dyn_id=${dyn_id%%.*}
        unique_disqus_string=${disqus_string//DYNAMIC_ID/$dyn_id}
        sed -i "/<div\ role=\"contentinfo\">/i\ $unique_disqus_string" $html_f
    fi
done

# or     $ find . -type f -exec sed -e 's/cpu/memory/ig' '{}' \;
# see http://blog.miniasp.com/post/2010/12/24/Useful-tool-Find-and-Replace-with-sed-command.aspx

# ==== Add locale menu ====

for html_f in $html_files
do
    if grep -q 'clearfix' $html_f; then
        echo skip locale - already added
    else
        html_name=${html_f##*/}
        echo ----- Adding locale to $html_name ...
        if ( echo $html_f | grep -q '/en/' ); then
            localemenu_each=${localemenu/LinkToChinese/\\.\\.\\\/${html_name/./\\.}}
            localemenu_each=${localemenu_each/LinkToEnglish/${html_name/./\\.}}
        else
            localemenu_each=${localemenu/LinkToChinese/${html_name/./\\.}}
            localemenu_each=${localemenu_each/LinkToEnglish/en\\\/${html_name/./\\.}}
        fi
        # delete 3 lines before class "wy-menu wy-menu-vertical"
        vi -e - $html_f <<COMMANDEND
g/wy-menu wy-menu-vertical/-3,-1d
wq
COMMANDEND
        # add locale menu body
        sed -i "/wy-menu wy-menu-vertical/i\ $localemenu_each" $html_f
        # add a </div> back, which was deleted by vi
        sed -i "/wy-menu wy-menu-vertical/i\ <\/div>" $html_f
    fi
done

# ==== Replace project name in Chinese with English ====

en_html_files=$(ls _build/html/en/*.html)

for html_f in $en_html_files
do
    echo ----- Finalizing English Locale of ${html_f##*/} ...
    sed -i -e 's/GMT 教學手冊/GMT Tutorials /g' $html_f
    sed -i -e 's/zzz_replace_token/English/g' $html_f
done

zhtw_html_files=$(ls _build/html/*.html)

for html_f in $zhtw_html_files
do
    echo ----- Finalizing Zhtw Locale of ${html_f##*/} ...
    sed -i -e 's/zzz_replace_token/中文 (台灣)/g' $html_f
done
